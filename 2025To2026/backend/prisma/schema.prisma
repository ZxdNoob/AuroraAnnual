// Prisma Schema - 全栈学习激励平台数据库设计

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 用户相关模型
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  username      String    @unique
  password     String
  nickname      String?
  avatar        String?
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 关联关系
  profile       UserProfile?
  checkIns      CheckIn[]
  points        Point[]
  userRanks     UserRank[]
  experiences   Experience[]
  userBadges    UserBadge[]
  lotteries     Lottery[]
  userItems     UserItem[]
  codeFiles     CodeFile[]
  activityParticipants ActivityParticipant[]

  @@index([email])
  @@index([username])
  @@index([role])
  @@map("users")
}

model UserProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  bio           String?
  location      String?
  website       String?
  github        String?
  totalPoints   Int      @default(0)
  currentRankId String?
  currentLevel  Int      @default(1)
  currentExp    Int      @default(0)
  nextLevelExp  Int      @default(100)
  consecutiveLoginDays   Int @default(0)
  consecutiveCheckInDays  Int @default(0)
  totalCheckInDays        Int @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentRank   Rank?    @relation(fields: [currentRankId], references: [id])

  @@index([userId])
  @@map("user_profiles")
}

// ============================================
// 打卡相关模型
// ============================================

model CheckIn {
  id            String   @id @default(uuid())
  userId        String
  checkInDate   DateTime @default(now())
  pointsEarned   Int
  expEarned      Int
  consecutiveDays Int
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, checkInDate])
  @@index([userId])
  @@index([checkInDate])
  @@map("check_ins")
}

// ============================================
// 积分相关模型
// ============================================

model Point {
  id            String   @id @default(uuid())
  userId        String
  amount        Int
  type          PointType
  description   String?
  relatedId     String?
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("points")
}

// ============================================
// 段位相关模型
// ============================================

model Rank {
  id            String   @id @default(uuid())
  name          String   @unique
  level         Int      @unique
  minStars      Int      @default(1)
  maxStars      Int
  requiredCheckIns Int
  season        Int      @default(1) // 赛季数（累加，从 1 开始）
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userRanks     UserRank[]
  userProfiles  UserProfile[]

  @@index([level])
  @@index([season])
  @@map("ranks")
}

model UserRank {
  id            String   @id @default(uuid())
  userId        String
  rankId        String
  stars         Int      @default(1)
  checkInCount  Int      @default(0)
  season        Int      // 赛季数（累加，从 1 开始）
  achievedAt    DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rank          Rank     @relation(fields: [rankId], references: [id], onDelete: Cascade)

  @@unique([userId, rankId, season])
  @@index([userId])
  @@index([rankId])
  @@index([season])
  @@map("user_ranks")
}

// ============================================
// 经验相关模型
// ============================================

model Experience {
  id            String   @id @default(uuid())
  userId        String
  amount        Int
  type          ExperienceType
  description   String?
  relatedId     String?
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("experiences")
}

// ============================================
// 勋章相关模型
// ============================================

model Badge {
  id            String   @id @default(uuid())
  name          String   @unique
  description   String?
  icon          String
  type          BadgeType
  condition     Json
  rarity        BadgeRarity @default(COMMON)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userBadges    UserBadge[]

  @@index([type])
  @@index([rarity])
  @@map("badges")
}

model UserBadge {
  id            String   @id @default(uuid())
  userId        String
  badgeId       String
  achievedAt    DateTime @default(now())
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge         Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badges")
}

// ============================================
// 抽奖相关模型
// ============================================

model Lottery {
  id            String   @id @default(uuid())
  userId        String
  prizeType     PrizeType
  prizeId       String?
  prizeName     String
  prizeValue    Int?
  cost          Int
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([prizeType])
  @@index([createdAt])
  @@map("lotteries")
}

// ============================================
// 道具相关模型
// ============================================

model Item {
  id            String   @id @default(uuid())
  name          String   @unique
  description   String?
  type          ItemType
  effect        Json
  icon          String
  rarity        ItemRarity @default(COMMON)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userItems     UserItem[]

  @@index([type])
  @@index([rarity])
  @@map("items")
}

model UserItem {
  id            String   @id @default(uuid())
  userId        String
  itemId        String
  quantity      Int      @default(1)
  isUsed        Boolean  @default(false)
  usedAt        DateTime?
  expiresAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  item          Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([itemId])
  @@index([isUsed])
  @@map("user_items")
}

// ============================================
// 活动相关模型
// ============================================

model Activity {
  id            String   @id @default(uuid())
  name          String
  description   String?
  startTime     DateTime
  endTime       DateTime
  isActive      Boolean  @default(true)
  rewards       Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  participants  ActivityParticipant[]

  @@index([startTime])
  @@index([endTime])
  @@index([isActive])
  @@map("activities")
}

model ActivityParticipant {
  id            String   @id @default(uuid())
  userId        String
  activityId    String
  rewardLevel   String?
  rewardValue   Int?
  participatedAt DateTime @default(now())
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activity      Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@unique([userId, activityId])
  @@index([userId])
  @@index([activityId])
  @@map("activity_participants")
}

// ============================================
// 代码文件相关模型
// ============================================

model CodeFile {
  id            String   @id @default(uuid())
  userId        String
  name          String
  path          String
  content       String   @default("")
  language      String
  isFolder      Boolean  @default(false)
  parentId      String?
  size          Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([parentId])
  @@index([path])
  @@map("code_files")
}

// ============================================
// 枚举类型
// ============================================

enum UserRole {
  USER
  SUPER_ADMIN

  @@map("user_role")
}

enum PointType {
  CHECK_IN
  LOTTERY
  ACTIVITY
  CONSUME

  @@map("point_type")
}

enum ExperienceType {
  LOGIN
  CHECK_IN
  CONSECUTIVE_LOGIN
  CONSECUTIVE_CHECK_IN
  LEVEL_BONUS

  @@map("experience_type")
}

enum BadgeType {
  CHECK_IN
  LOGIN
  LEVEL
  RANK
  MILESTONE

  @@map("badge_type")
}

enum BadgeRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY

  @@map("badge_rarity")
}

enum PrizeType {
  RED_PACKET
  ITEM
  LIMITED_REWARD

  @@map("prize_type")
}

enum ItemType {
  EXP_BOOST
  POINTS_BOOST
  RANK_BOOST

  @@map("item_type")
}

enum ItemRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY

  @@map("item_rarity")
}

