# 系统架构概览

## 架构设计原则

1. **前后端分离**：前端和后端完全分离，通过 RESTful API 通信
2. **类型安全**：全栈使用 TypeScript，确保类型安全
3. **可扩展性**：模块化设计，支持功能扩展
4. **高性能**：采用现代高性能技术栈
5. **可维护性**：清晰的代码结构和完善的文档

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                │
│              PC 端浏览器 / 移动端浏览器 / 移动端 App          │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ HTTPS
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                      前端层 (Next.js)                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │  页面    │  │  组件    │  │  状态    │  │  工具   │      │
│  │  Pages   │  │Components│  │  Store   │  │  Utils  │      │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘      │
│  ┌──────────────────────────────────────────────────────┐    │
│  │           在线编码系统 (Monaco Editor)               │    │
│  └──────────────────────────────────────────────────────┘    │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ RESTful API
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                    API 网关层                                │
│             认证、授权、限流、日志、监控                       │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                   后端服务层 (NestJS)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  用户模块    │  │  积分模块    │  │  段位模块    │      │
│  │  User        │  │  Points      │  │  Rank        │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  经验模块    │  │  勋章模块    │  │  抽奖模块    │      │
│  │  Experience   │  │  Badge       │  │  Lottery      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  编码模块    │  │  活动模块    │  │  权益模块    │      │
│  │  Code        │  │  Activity    │  │  Privilege   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                   数据层                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ PostgreSQL   │  │    Redis     │  │  文件存储    │      │
│  │  (主数据库)   │  │   (缓存)     │  │  (代码文件)  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

## 技术栈选型

### 前端技术栈

| 技术 | 版本 | 用途 | 选型原因 |
|------|------|------|----------|
| Next.js | 14+ | 全栈框架 | 服务端渲染、路由、API 路由 |
| React | 19.2 | UI 框架 | 最新稳定版本，性能优秀 |
| TypeScript | 5+ | 类型系统 | 类型安全，提升开发体验 |
| Tailwind CSS | 3+ | 样式框架 | 实用优先，开发效率高 |
| shadcn/ui | latest | UI 组件库 | 高质量组件，可定制 |
| Zustand | latest | 状态管理 | 轻量级，API 简洁 |
| TanStack Query | latest | 数据获取 | 强大的缓存和同步机制 |
| React Hook Form | latest | 表单处理 | 性能优秀，易于使用 |
| Zod | latest | 数据验证 | TypeScript 友好的验证库 |
| Monaco Editor | latest | 代码编辑器 | VS Code 编辑器内核 |

### 后端技术栈

| 技术 | 版本 | 用途 | 选型原因 |
|------|------|------|----------|
| NestJS | 10+ | Web 框架 | 企业级框架，模块化设计 |
| TypeScript | 5+ | 类型系统 | 类型安全，与前端统一 |
| Prisma | 5+ | ORM | 现代 ORM，类型安全，迁移方便 |
| PostgreSQL | 15+ | 主数据库 | 功能强大，性能优秀 |
| Redis | 7+ | 缓存/会话 | 高性能内存数据库 |
| JWT | latest | 认证 | 无状态认证，易于扩展 |
| Passport.js | latest | 认证中间件 | 灵活的认证策略 |
| Swagger | latest | API 文档 | 自动生成 API 文档 |

### 基础设施

| 技术 | 版本 | 用途 | 选型原因 |
|------|------|------|----------|
| Docker | latest | 容器化 | 环境一致性，易于部署 |
| Docker Compose | latest | 容器编排 | 本地开发环境管理 |
| GitHub Actions | latest | CI/CD | 与 GitHub 集成，免费 |
| Vercel | - | 前端部署 | Next.js 官方推荐 |
| Railway/Fly.io | - | 后端部署 | 全栈部署平台 |

## 模块设计

### 用户模块 (User Module)

**职责**：
- 用户注册、登录、登出
- 用户信息管理
- 权限管理（超级管理员）
- 用户认证和授权

**核心功能**：
- JWT 认证
- 密码加密（bcrypt）
- 用户角色管理
- 用户状态管理

### 积分模块 (Points Module)

**职责**：
- 积分获取和消费
- 积分记录
- 积分排行榜
- 连续打卡积分加成算法

**核心算法**：
```typescript
// 连续打卡积分加成算法
function calculatePoints(consecutiveDays: number): number {
  // 基础积分
  let basePoints = 5;
  
  // 连续打卡加成（最多 10 分）
  let bonusPoints = Math.min(consecutiveDays, 10);
  
  return basePoints + bonusPoints;
}
```

### 段位模块 (Rank Module)

**职责**：
- 段位等级管理
- 段位晋升和降级
- 赛季管理
- 段位继承机制

**段位等级**：
1. 倔强黑铁（1-2 星）
2. 不屈白银（1-3 星）
3. 黄金（1-5 星）
4. 白金（1-5 星）
5. 钻石（1-5 星）
6. 星耀（1-5 星）
7. 不凡大师（1-5 星）
8. 宗师（1-5 星）
9. 最强王者（1-5 星）
10. 非凡王者（1-5 星）
11. 至圣王者（1-5 星）
12. 荣耀王者（1-5 星）
13. 传奇王者（无上限，1 星到 n 星）

**赛季机制**：
- **赛季累加机制**：赛季数一直累加，不会重置
- **第一赛季**：2026 年 1 月 1 日 - 2026 年 6 月 30 日
- **第二赛季**：2026 年 7 月 1 日 - 2026 年 12 月 31 日
- **第三赛季**：2027 年 1 月 1 日 - 2027 年 6 月 30 日
- **依此类推**：每半年一个赛季，赛季数持续累加
- **赛季结束**：段位继承（有降段机制）
- 长期不打卡：每月降一个段位

### 经验模块 (Experience Module)

**职责**：
- 经验值获取和累加
- 等级计算
- 经验值加成（连续登录、连续打卡）
- 等级权益管理

**经验值计算**：
```typescript
// 经验值计算
function calculateExperience(
  baseExp: number,
  consecutiveLoginDays: number,
  consecutiveCheckInDays: number
): number {
  // 基础经验值
  let experience = baseExp;
  
  // 连续登录加成（每天 +1）
  experience += consecutiveLoginDays;
  
  // 连续打卡加成（每天 +2）
  experience += consecutiveCheckInDays * 2;
  
  return experience;
}
```

### 勋章模块 (Badge Module)

**职责**：
- 勋章定义和管理
- 勋章获取条件检查
- 勋章展示
- SVG 图标生成

**勋章类型**：
- 连续打卡勋章（7 天、30 天、100 天、365 天）
- 连续登录勋章（7 天、30 天、100 天、365 天）
- 等级达成勋章（10 级、20 级、30 级、50 级、100 级）
- 段位达成勋章（每个段位首次达成）
- 里程碑勋章（特殊成就）

### 抽奖模块 (Lottery Module)

**职责**：
- 抽奖算法实现
- 奖品管理
- 抽奖记录
- 活动管理

**奖品类型**：
- 红包（现金奖励）
- 道具（经验加成卡、积分加成卡、段位加成卡）
- 限定奖励（活动期间的一等奖、二等奖、三等奖）

### 编码模块 (Code Module)

**职责**：
- 在线代码编辑器
- 文件管理（创建、删除、重命名、移动）
- 代码执行（可选）
- 代码保存和版本管理

**技术实现**：
- Monaco Editor（VS Code 编辑器内核）
- 支持多种语言（JavaScript、TypeScript、Python、Go、Java 等）
- 文件系统管理
- 代码高亮和自动补全

### 活动模块 (Activity Module)

**职责**：
- 活动创建和管理
- 活动时间范围管理
- 活动奖励配置
- 活动参与记录

### 权益模块 (Privilege Module)

**职责**：
- 权益定义和管理
- 权益分配（基于等级和段位）
- 权益使用记录

**权益示例**：
- 经验达到 20 级：每天打卡有经验值和积分加成
- 段位达到钻石：每日登录经验值 +50%
- 段位达到王者：每日打卡积分 +100%

## 数据流设计

### 用户登录流程

```
用户输入账号密码
    ↓
前端验证（Zod）
    ↓
发送登录请求（POST /api/auth/login）
    ↓
后端验证（JWT + Passport）
    ↓
返回 Token 和用户信息
    ↓
前端存储 Token（localStorage/cookie）
    ↓
后续请求携带 Token
```

### 打卡流程

```
用户点击打卡
    ↓
前端发送打卡请求（POST /api/checkin）
    ↓
后端处理：
  1. 检查今日是否已打卡
  2. 计算连续打卡天数
  3. 计算积分（基础 + 连续加成）
  4. 计算经验值（基础 + 连续加成）
  5. 检查段位晋升条件
  6. 检查勋章获取条件
    ↓
返回打卡结果（积分、经验、段位变化等）
    ↓
前端更新用户状态
```

### 段位晋升流程

```
用户打卡
    ↓
检查段位晋升条件
    ↓
计算当前段位星级
    ↓
判断是否达到下一段位
    ↓
晋升段位（更新数据库）
    ↓
触发段位达成勋章
    ↓
返回段位变化信息
```

## 安全设计

### 认证和授权

- **JWT Token**：无状态认证，支持分布式系统
- **Token 过期时间**：7 天（可配置）
- **Refresh Token**：支持 Token 刷新机制
- **密码加密**：bcrypt（成本因子 10）

### 数据安全

- **HTTPS**：所有通信使用 HTTPS
- **SQL 注入防护**：使用 Prisma ORM，自动防护
- **XSS 防护**：React 自动转义，Content Security Policy
- **CSRF 防护**：SameSite Cookie，Token 验证

### 权限控制

- **超级管理员**：系统唯一，拥有所有权限
- **普通用户**：只能操作自己的数据
- **API 权限**：基于角色的访问控制（RBAC）

## 性能优化

### 前端优化

- **代码分割**：Next.js 自动代码分割
- **图片优化**：Next.js Image 组件
- **缓存策略**：TanStack Query 缓存
- **懒加载**：组件和路由懒加载

### 后端优化

- **数据库索引**：关键字段建立索引
- **Redis 缓存**：热点数据缓存
- **连接池**：数据库连接池管理
- **查询优化**：避免 N+1 查询

## 监控和日志

### 应用监控

- **Sentry**：错误追踪和性能监控
- **日志系统**：结构化日志（Winston）
- **性能监控**：API 响应时间监控

### 基础设施监控

- **Prometheus**：指标收集
- **Grafana**：可视化仪表板

## 部署架构

### 开发环境

```
本地开发
  ├── 前端：localhost:3000 (Next.js Dev Server)
  ├── 后端：localhost:4000 (NestJS Dev Server)
  ├── 数据库：localhost:5432 (PostgreSQL)
  └── 缓存：localhost:6379 (Redis)
```

### 生产环境

```
用户请求
    ↓
CDN (Vercel Edge Network)
    ↓
前端 (Vercel)
    ↓
API Gateway
    ↓
后端服务 (Railway/Fly.io)
    ↓
数据库 (PostgreSQL)
    ↓
缓存 (Redis)
```

## 扩展性设计

### 水平扩展

- **无状态服务**：后端服务无状态，支持水平扩展
- **数据库读写分离**：支持主从复制
- **缓存集群**：Redis 集群模式

### 垂直扩展

- **模块化设计**：功能模块独立，易于扩展
- **插件机制**：支持功能插件化
- **API 版本管理**：支持 API 版本控制

## 总结

本架构设计遵循业界最佳实践，采用现代全栈技术栈，确保系统的高性能、可扩展性和可维护性。通过模块化设计和清晰的职责划分，系统易于开发和维护，同时具备良好的扩展性。

