# 版本更新文档：v0.2.1 → v0.3.0

## 基本信息

- **更新日期**：2026-01-02 22:09:54
- **更新类型**：MINOR（新功能添加和系统优化）
- **更新范围**：用户认证系统、Header 组件优化、版本管理优化、Bug 修复
- **预计影响**：中等（新增用户认证功能，需要用户重新注册登录）

## 更新内容概览

### 新增功能

1. **真实用户注册登录系统**
   - 实现完整的用户注册功能（邮箱、用户名、密码、昵称）
   - 实现用户登录功能（支持邮箱/用户名登录）
   - 集成 JWT 认证机制，使用 localStorage 存储 token
   - 创建 `AuthContext` 和 `AuthProvider` 提供全局认证状态管理
   - 创建 `useAuth` Hook 方便组件使用认证功能
   - 创建 `RequireAuth` 组件保护需要认证的路由
   - 移除默认测试账号，所有用户需要真实注册登录

2. **用户认证相关页面**
   - 创建登录页面（`/login`）
   - 创建注册页面（`/register`）
   - 实现表单验证和错误处理
   - 支持登录后重定向到原访问页面

3. **后端用户管理 API**
   - 创建 `UsersModule`、`UsersController`、`UsersService`
   - 实现 `/api/users/me` 接口获取当前用户信息
   - 实现 `/api/users/me/profile` 接口获取当前用户资料
   - 所有接口使用 JWT 认证保护

### 功能改进

1. **Header 组件优化**
   - 未登录用户不显示导航菜单（采用业界最佳实践）
   - 在登录/注册页面时，PC 端不显示登录/注册按钮（避免重复）
   - 在首页未登录时，PC 端不显示登录/注册按钮（首页已有提示）
   - 已登录用户始终显示用户菜单（包括登录/注册页面）
   - 优化移动端菜单显示逻辑

2. **版本管理优化**
   - VERSION 文件明确区分前端和后端版本
   - 同步更新前端和后端 `package.json` 中的版本号
   - 更新 README.md 版本信息说明

### Bug 修复

1. **React Hydration 错误修复**
   - 修复服务端和客户端渲染不一致导致的 Hydration 错误
   - 使用 `mounted` 状态确保客户端 hydration 完成后再渲染依赖认证状态的内容
   - 使用 `suppressHydrationWarning` 属性抑制预期的 hydration 警告
   - 优化 `AuthContext` 的初始化逻辑，确保服务端渲染时 `isLoading` 为 `false`
   - 修复登录/注册页面按钮的 loading 状态显示问题
   - 修复 `RequireAuth` 组件的加载状态显示问题

2. **首页显示逻辑优化**
   - 未登录用户显示"请先登录"提示卡片
   - 已登录用户显示完整的用户数据和统计信息
   - 优化加载状态显示（使用骨架屏）

### 文档更新

1. **创建用户认证相关文档**
   - 创建 React Hydration 错误修复文档（`docs/troubleshooting/2026-01-02-react-hydration-error.md`）
   - 更新常见问题文档，添加 Hydration 错误快速参考

2. **更新项目文档**
   - 更新 README.md 版本信息
   - 更新版本更新记录

## 依赖项变更

### 前端依赖

无新增或删除依赖，所有依赖版本保持不变。

### 后端依赖

无新增或删除依赖，所有依赖版本保持不变。

## 破坏性变更

### 1. 移除默认测试账号

**变更内容**：
- 移除了默认的测试账号登录功能
- 所有用户必须通过注册页面创建账号
- 已存在的测试账号数据需要重新注册

**影响范围**：
- 所有使用测试账号的用户
- 开发环境需要重新注册账号

**迁移方案**：
1. 访问 `/register` 页面注册新账号
2. 使用注册的账号登录系统
3. 如需保留原有数据，需要联系管理员进行数据迁移

## 升级指南

### 前置条件

1. **备份当前数据**（如果已有重要数据）
   ```bash
   # 备份数据库
   docker-compose exec postgres pg_dump -U postgres learning_platform > backup.sql
   ```

2. **检查当前版本**
   ```bash
   # 查看前端版本
   cat 2025To2026/frontend/package.json | grep version
   
   # 查看后端版本
   cat 2025To2026/backend/package.json | grep version
   ```

### 升级步骤

#### 步骤 1：更新代码

```bash
# 拉取最新代码
git pull origin main

# 检查版本文件
cat 2025To2026/VERSION
```

#### 步骤 2：更新依赖

```bash
# 前端依赖
cd 2025To2026/frontend
npm install

# 后端依赖
cd ../backend
npm install
```

#### 步骤 3：数据库迁移

```bash
# 运行数据库迁移（如果需要）
cd 2025To2026/backend
npm run prisma:migrate
```

#### 步骤 4：重新构建

```bash
# 前端构建
cd 2025To2026/frontend
npm run build

# 后端构建
cd ../backend
npm run build
```

#### 步骤 5：重启服务

```bash
# 使用 Docker Compose 重启
cd 2025To2026
docker-compose down
docker-compose up -d
```

#### 步骤 6：验证功能

1. **访问首页**
   - 确认未登录时显示"请先登录"提示
   - 确认右上角不显示登录/注册按钮

2. **注册新账号**
   - 访问 `/register` 页面
   - 填写注册信息并提交
   - 确认注册成功

3. **登录系统**
   - 访问 `/login` 页面
   - 使用注册的账号登录
   - 确认登录成功并跳转到首页

4. **验证认证功能**
   - 确认登录后显示用户菜单
   - 确认可以访问需要认证的页面
   - 确认退出登录功能正常

## 兼容性分析

### 向后兼容性

- **部分兼容**：MINOR 版本更新，新增功能不影响现有功能
- **破坏性变更**：移除默认测试账号，需要用户重新注册

### 浏览器兼容性

| 浏览器 | 最低版本 | 说明 |
|--------|---------|------|
| Chrome | 90+ | 完全支持 |
| Firefox | 88+ | 完全支持 |
| Safari | 14+ | 完全支持 |
| Edge | 90+ | 完全支持 |

### Node.js 兼容性

- **前端**：Node.js 18.17+（Next.js 14 要求）
- **后端**：Node.js 20+ LTS（NestJS 10 推荐）

## 测试验证

### 单元测试

```bash
# 前端测试（如果有）
cd 2025To2026/frontend
npm run test

# 后端测试
cd ../backend
npm run test
```

### 功能测试清单

- [x] 用户注册功能正常
- [x] 用户登录功能正常
- [x] JWT 认证机制正常
- [x] Header 组件显示逻辑正确
- [x] 登录/注册页面不显示重复按钮
- [x] 首页未登录时不显示重复按钮
- [x] React Hydration 错误已修复
- [x] 路由保护功能正常
- [x] 用户信息获取正常

## 回滚方案

如果升级后出现问题，可以按照以下步骤回滚：

### 步骤 1：回滚代码

```bash
# 切换到上一个版本标签
git checkout v0.2.1

# 或回滚到特定提交
git checkout <commit-hash>
```

### 步骤 2：恢复依赖

```bash
# 恢复前端 package.json
git checkout v0.2.1 -- 2025To2026/frontend/package.json

# 恢复后端 package.json
git checkout v0.2.1 -- 2025To2026/backend/package.json

# 重新安装依赖
cd 2025To2026/frontend && npm install
cd ../backend && npm install
```

### 步骤 3：恢复数据库（如果需要）

```bash
# 恢复数据库备份
docker-compose exec postgres psql -U postgres learning_platform < backup.sql
```

### 步骤 4：重启服务

```bash
cd 2025To2026
docker-compose restart
```

## 经验总结

### 升级过程中的收获

1. **用户认证系统**
   - JWT 认证机制简单高效，适合前后端分离架构
   - `AuthContext` 提供全局认证状态管理，使用方便
   - `RequireAuth` 组件简化了路由保护逻辑

2. **React Hydration 错误处理**
   - 使用 `mounted` 状态确保客户端 hydration 完成后再渲染
   - `suppressHydrationWarning` 可以抑制预期的 hydration 警告
   - 服务端和客户端状态一致性是关键

3. **Header 组件优化**
   - 未登录时不显示导航菜单符合业界最佳实践
   - 避免在已有登录提示的页面重复显示按钮，提升用户体验

4. **版本管理**
   - 明确区分前端和后端版本，便于独立管理
   - 同步更新 VERSION 文件和 package.json，保持一致性

### 最佳实践

1. **认证系统设计**
   - 使用 JWT 进行无状态认证
   - 使用 Context API 管理全局认证状态
   - 创建 `RequireAuth` 组件保护需要认证的路由

2. **Hydration 错误处理**
   - 在服务端渲染时，避免使用客户端特定的 API（如 `localStorage`）
   - 使用 `mounted` 状态确保客户端 hydration 完成后再渲染
   - 对于预期的服务端和客户端差异，使用 `suppressHydrationWarning`

3. **UI/UX 优化**
   - 未登录用户不显示导航菜单，避免混淆
   - 避免在已有登录提示的页面重复显示按钮
   - 提供清晰的登录/注册入口

4. **版本管理**
   - 明确区分前端和后端版本
   - 同步更新所有版本相关文件
   - 创建详细的版本更新文档

## 参考资料

- [Next.js App Router 文档](https://nextjs.org/docs/app)
- [React Context API 文档](https://react.dev/reference/react/useContext)
- [JWT 认证最佳实践](https://jwt.io/introduction)
- [React Hydration 错误处理](https://react.dev/reference/react-dom/client/hydrateRoot)
- [项目 CHANGELOG](../README.md#更新记录)
- [版本管理规范](../../../.cursor/rules/version-management.mdc)

